<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Groove - Crear Cuenta</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Efectos de fondo -->
    <div class="chrome-object obj-right-top"></div>
    
    <!-- Navegaci√≥n -->
    <nav class="auth-nav">
        <a href="index.html" class="back-to-home">
            <i class="fas fa-arrow-left"></i>
            <span>Volver a Natural Groove</span>
        </a>
        <div class="auth-nav-links">
            <span>¬øYa tienes cuenta?</span>
            <a href="login.html" class="auth-link">Inicia sesi√≥n</a>
        </div>
    </nav>
    
    <!-- Contenedor principal -->
    <main class="auth-container">
        <div class="auth-form-wrapper">
            <!-- Header -->
            <div class="auth-header">
                <h1 class="auth-title">√önete a Natural Groove</h1>
                <p class="auth-subtitle">Crea tu cuenta y forma parte de la comunidad raver</p>
            </div>
            
            <!-- Formulario -->
            <form id="registerForm" class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName" class="form-label">
                            <i class="fas fa-user"></i>
                            Nombre Completo
                        </label>
                        <input 
                            type="text" 
                            id="fullName" 
                            name="fullName" 
                            class="form-input" 
                            placeholder="Tu nombre completo"
                            required
                            autocomplete="name"
                        >
                        <div class="form-error" id="fullNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="username" class="form-label">
                            <i class="fas fa-at"></i>
                            Username
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            class="form-input" 
                            placeholder="tu_username"
                            required
                            autocomplete="username"
                        >
                        <div class="form-error" id="usernameError"></div>
                        <div class="form-hint">M√≠nimo 3 caracteres, sin espacios</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope"></i>
                        Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="tu@email.com"
                        required
                        autocomplete="email"
                    >
                    <div class="form-error" id="emailError"></div>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock"></i>
                        Contrase√±a
                    </label>
                    <div class="password-input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-input" 
                            placeholder="M√≠nimo 6 caracteres"
                            required
                            autocomplete="new-password"
                        >
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                    <div class="form-error" id="passwordError"></div>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">
                        <i class="fas fa-lock"></i>
                        Confirmar Contrase√±a
                    </label>
                    <div class="password-input-wrapper">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            class="form-input" 
                            placeholder="Repite tu contrase√±a"
                            required
                            autocomplete="new-password"
                        >
                        <button type="button" class="password-toggle" onclick="toggleConfirmPassword()">
                            <i class="fas fa-eye" id="confirmPasswordToggleIcon"></i>
                        </button>
                    </div>
                    <div class="form-error" id="confirmPasswordError"></div>
                </div>
                
                <div class="form-group">
                    <label for="favoriteGenre" class="form-label">
                        <i class="fas fa-music"></i>
                        G√©nero Musical Favorito
                    </label>
                    <select id="favoriteGenre" name="favoriteGenre" class="form-input">
                        <option value="">Selecciona un g√©nero</option>
                        <option value="techno">Techno</option>
                        <option value="house">House</option>
                        <option value="trance">Trance</option>
                        <option value="drum-bass">Drum & Bass</option>
                        <option value="dubstep">Dubstep</option>
                        <option value="ambient">Ambient</option>
                        <option value="hardcore">Hardcore</option>
                        <option value="progressive">Progressive</option>
                        <option value="minimal">Minimal</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="acceptTerms" name="acceptTerms" required>
                        <span class="checkmark"></span>
                        Acepto los <a href="#" class="terms-link">t√©rminos y condiciones</a> y la <a href="#" class="terms-link">pol√≠tica de privacidad</a>
                    </label>
                    <div class="form-error" id="acceptTermsError"></div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="acceptMarketing" name="acceptMarketing">
                        <span class="checkmark"></span>
                        Quiero recibir noticias y actualizaciones de Natural Groove
                    </label>
                </div>
                
                <button type="submit" class="auth-button primary" id="registerButton">
                    <span class="button-text">Crear Cuenta</span>
                    <div class="button-spinner" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </button>
            </form>
            
            <!-- Separador -->
            <div class="auth-separator">
                <span>o reg√≠strate con</span>
            </div>
            
            <!-- Social Login (Placeholder) -->
            <div class="social-login">
                <button type="button" class="social-button google" onclick="socialLogin('google')">
                    <i class="fab fa-google"></i>
                    Google
                </button>
                <button type="button" class="social-button github" onclick="socialLogin('github')">
                    <i class="fab fa-github"></i>
                    GitHub
                </button>
            </div>
            
            <!-- Footer -->
            <div class="auth-footer">
                <p>¬øYa tienes cuenta? <a href="login.html">Inicia sesi√≥n aqu√≠</a></p>
            </div>
        </div>
    </main>
    
    <!-- Toast para mensajes -->
    <div id="toast" class="toast" style="display: none;"></div>
    
    <!-- Scripts -->
    <script type="module">
        import { authManager } from './assets/js/auth.js'
        import { utils } from './assets/js/supabase-config.js'
        
        // Elementos del DOM
        const registerForm = document.getElementById('registerForm')
        const registerButton = document.getElementById('registerButton')
        
        // Variables globales
        let isLoading = false
        let usernameCheckTimeout = null
        
        // Funci√≥n para mostrar/ocultar contrase√±a
        window.togglePassword = function() {
            const passwordInput = document.getElementById('password')
            const toggleIcon = document.getElementById('passwordToggleIcon')
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text'
                toggleIcon.classList.remove('fa-eye')
                toggleIcon.classList.add('fa-eye-slash')
            } else {
                passwordInput.type = 'password'
                toggleIcon.classList.remove('fa-eye-slash')
                toggleIcon.classList.add('fa-eye')
            }
        }
        
        // Funci√≥n para mostrar/ocultar confirmar contrase√±a
        window.toggleConfirmPassword = function() {
            const confirmPasswordInput = document.getElementById('confirmPassword')
            const toggleIcon = document.getElementById('confirmPasswordToggleIcon')
            
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text'
                toggleIcon.classList.remove('fa-eye')
                toggleIcon.classList.add('fa-eye-slash')
            } else {
                confirmPasswordInput.type = 'password'
                toggleIcon.classList.remove('fa-eye-slash')
                toggleIcon.classList.add('fa-eye')
            }
        }
        
        // Funci√≥n para login social (placeholder)
        window.socialLogin = function(provider) {
            utils.showToast(`Registro con ${provider} - Pr√≥ximamente`, 'info')
        }
        
        // Funci√≥n para limpiar errores
        function clearErrors() {
            const errorElements = document.querySelectorAll('.form-error')
            errorElements.forEach(element => element.textContent = '')
        }
        
        // Funci√≥n para mostrar errores
        function showError(field, message) {
            const errorElement = document.getElementById(field + 'Error')
            if (errorElement) {
                errorElement.textContent = message
            }
        }
        
        // Funci√≥n para toggle loading state
        function setLoadingState(loading) {
            isLoading = loading
            const buttonText = registerButton.querySelector('.button-text')
            const spinner = registerButton.querySelector('.button-spinner')
            
            if (loading) {
                buttonText.style.display = 'none'
                spinner.style.display = 'flex'
                registerButton.disabled = true
                registerButton.style.opacity = '0.7'
            } else {
                buttonText.style.display = 'block'
                spinner.style.display = 'none'
                registerButton.disabled = false
                registerButton.style.opacity = '1'
            }
        }
        
        // Funci√≥n para validar fuerza de contrase√±a
        function checkPasswordStrength(password) {
            const strengthElement = document.getElementById('passwordStrength')
            let strength = 0
            let feedback = []
            
            if (password.length >= 6) strength++
            if (password.match(/[a-z]/)) strength++
            if (password.match(/[A-Z]/)) strength++
            if (password.match(/[0-9]/)) strength++
            if (password.match(/[^a-zA-Z0-9]/)) strength++
            
            switch (strength) {
                case 0:
                case 1:
                    strengthElement.innerHTML = '<span class="strength-weak">D√©bil</span>'
                    break
                case 2:
                    strengthElement.innerHTML = '<span class="strength-fair">Regular</span>'
                    break
                case 3:
                    strengthElement.innerHTML = '<span class="strength-good">Buena</span>'
                    break
                case 4:
                case 5:
                    strengthElement.innerHTML = '<span class="strength-strong">Fuerte</span>'
                    break
            }
            
            return strength
        }
        
        // Funci√≥n para validar username
        async function validateUsername(username) {
            if (!username || username.length < 3) {
                showError('username', 'Username debe tener al menos 3 caracteres')
                return false
            }
            
            if (username.includes(' ')) {
                showError('username', 'Username no puede contener espacios')
                return false
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showError('username', 'Username solo puede contener letras, n√∫meros y guiones bajos')
                return false
            }
            
            // Verificar disponibilidad (con debounce)
            clearTimeout(usernameCheckTimeout)
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const { profiles } = await import('./assets/js/supabase-config.js')
                    const result = await profiles.checkUsernameExists(username)
                    
                    if (result.success && result.exists) {
                        showError('username', 'Este username ya est√° en uso')
                    } else {
                        showError('username', '')
                    }
                } catch (error) {
                    console.error('Error verificando username:', error)
                }
            }, 500)
            
            return true
        }
        
        // Manejar env√≠o del formulario
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault()
            
            if (isLoading) return
            
            // Obtener valores
            const formData = new FormData(registerForm)
            const userData = {
                fullName: formData.get('fullName').trim(),
                username: formData.get('username').trim(),
                email: formData.get('email').trim(),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword'),
                favoriteGenre: formData.get('favoriteGenre'),
                acceptTerms: formData.get('acceptTerms'),
                acceptMarketing: formData.get('acceptMarketing')
            }
            
            // Limpiar errores previos
            clearErrors()
            
            // Validaciones
            let hasErrors = false
            
            if (!userData.fullName) {
                showError('fullName', 'Nombre completo es requerido')
                hasErrors = true
            }
            
            if (!userData.username) {
                showError('username', 'Username es requerido')
                hasErrors = true
            }
            
            if (!userData.email) {
                showError('email', 'Email es requerido')
                hasErrors = true
            }
            
            if (!userData.password) {
                showError('password', 'Contrase√±a es requerida')
                hasErrors = true
            }
            
            if (userData.password !== userData.confirmPassword) {
                showError('confirmPassword', 'Las contrase√±as no coinciden')
                hasErrors = true
            }
            
            if (!userData.acceptTerms) {
                showError('acceptTerms', 'Debes aceptar los t√©rminos y condiciones')
                hasErrors = true
            }
            
            if (hasErrors) return
            
            // Mostrar loading
            setLoadingState(true)
            
            try {
                // Intentar registro
                const result = await authManager.handleRegister(userData)
                
                if (result.success) {
                    if (result.needsVerification) {
                        utils.showToast('¬°Cuenta creada! Revisa tu email para confirmar tu cuenta.', 'success')
                        setTimeout(() => {
                            window.location.href = 'login.html'
                        }, 3000)
                    } else {
                        utils.showToast('¬°Cuenta creada exitosamente! Redirigiendo...', 'success')
                        setTimeout(() => {
                            window.location.href = 'index.html'
                        }, 1500)
                    }
                } else {
                    // Mostrar error espec√≠fico
                    if (result.error.toLowerCase().includes('email')) {
                        showError('email', result.error)
                    } else if (result.error.toLowerCase().includes('username')) {
                        showError('username', result.error)
                    } else if (result.error.toLowerCase().includes('password')) {
                        showError('password', result.error)
                    } else {
                        utils.showToast(result.error, 'error')
                    }
                }
            } catch (error) {
                utils.showToast('Error de conexi√≥n. Intenta de nuevo.', 'error')
                console.error('Error en registro:', error)
            } finally {
                setLoadingState(false)
            }
        })
        
        // Validaciones en tiempo real
        document.getElementById('fullName').addEventListener('blur', function() {
            const fullName = this.value.trim()
            if (fullName && fullName.length < 2) {
                showError('fullName', 'Nombre debe tener al menos 2 caracteres')
            } else {
                showError('fullName', '')
            }
        })
        
        document.getElementById('username').addEventListener('blur', function() {
            validateUsername(this.value.trim())
        })
        
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value.trim()
            if (email && !utils.isValidEmail(email)) {
                showError('email', 'Formato de email inv√°lido')
            } else {
                showError('email', '')
            }
        })
        
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value
            checkPasswordStrength(password)
            
            if (password && password.length < 6) {
                showError('password', 'La contrase√±a debe tener al menos 6 caracteres')
            } else {
                showError('password', '')
            }
            
            // Validar confirmaci√≥n si ya tiene valor
            const confirmPassword = document.getElementById('confirmPassword').value
            if (confirmPassword && password !== confirmPassword) {
                showError('confirmPassword', 'Las contrase√±as no coinciden')
            } else if (confirmPassword) {
                showError('confirmPassword', '')
            }
        })
        
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('password').value
            const confirmPassword = this.value
            
            if (confirmPassword && password !== confirmPassword) {
                showError('confirmPassword', 'Las contrase√±as no coinciden')
            } else {
                showError('confirmPassword', '')
            }
        })
        
        // Limpiar errores al escribir
        const inputs = ['fullName', 'username', 'email']
        inputs.forEach(inputId => {
            document.getElementById(inputId).addEventListener('input', function() {
                if (this.value.trim()) {
                    showError(inputId, '')
                }
            })
        })
        
        // Redirigir si ya est√° autenticado
        authManager.redirectIfAuthenticated()
        
        console.log('üìù P√°gina de registro inicializada')
    </script>
    
    <!-- Script para animaciones -->
    <script>
        // Animaciones de entrada
        document.addEventListener('DOMContentLoaded', function() {
            const authFormWrapper = document.querySelector('.auth-form-wrapper')
            
            // Fade in animation
            setTimeout(() => {
                authFormWrapper.style.opacity = '1'
                authFormWrapper.style.transform = 'translateY(0)'
            }, 100)
            
            // Focus en el primer input
            document.getElementById('fullName').focus()
        })
    </script>
</body>
</html>